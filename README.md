# Machine learning-based probabilistic forecasting of solar irradiance in Chile

## ðŸ“Œ Overview
This project focuses on probabilistic forecasting of solar irradiance in Chile using machine learning techniques and ensemble model output statistics (EMOS).

Related work: Baran, S., Marin, J. C., Cuevas, O., DÃ­az, M., SzabÃ³, M., Nicolis, O. and Lakatos, M. (2024) Machine learning-based probabilistic forecasting of solar irradiance in Chile. *arXiv:2411.11073*.

## ðŸ“Š Dataset
- Eight-member ensemble forecasts for solar irradiance generated by the Weather Research and Forecasting (WRF) model and corresponding observations
- We consider data from 30 stations in the Atacama and Coquimbo regions, between the coast and the Andes Cordillera in Chile
- Time period: calendar year 2021
- All forecasts are initialized at 0000 UTC with a 1 h temporal resolution and a forecast horizon of 48 h

## Neural network-based calibration methods
The neural network-based models are implemented in Python and follow these steps:

1. **Data Loading**
   - Load radiation data and station information.
   - Extract latitude, longitude, and altitude details.

2. **Preprocessing**
   - Standardize features.
   - Remove NaN values and validate data.

3. **Model Training**
   - Train multiple models using different architectures (depending on CN0 distributional regression, corrected ensemble).
   - The `MODEL` variable determines whether a **censored normal distributional regression network (DRN)** is trained or a neural network obtaining **corrected ensemble forecast** :
     - `MODEL = "DRN"` trains a CN0 DRN.
     - `MODEL = "CORRENS"` train a neural network to obtain corrected ensemble forecasts.
   - Utilize `EarlyStopping` for better generalization.

4. **Evaluation & Prediction**
   - Optional: Compute CRPS
   - Generate probabilistic forecasts.
   - Reshape and store results for visualization.

### ðŸ“‚ Project structure
This section provides an overview of the Python files in this project.
The codes can be found in the `NeuralNetworks` folder.

- `radiation_postprocessing.py` - Main script to train and predict using the models.
- `models.py` - Constructs a feedforward neural network with customizable architecture, activation functions,  
and an optional compilation step.
- `preprocessing.py` - Functions for data cleaning and feature engineering.
- `losses.py` - Custom loss functions including CRPS (Note: The custom loss function of the CN0 DRN as implemented by [Horat et al. (2024)](https://github.com/HoratN/pp-modelchain?tab=readme-ov-file)).
- `custom_callbacks.py` - Custom Keras callbacks for training.
- `aux_functions.py` - Helper functions for reshaping data and for obtaining feature importance.

###  Dependencies
To run this project, you need the following Python libraries:

- `numpy` 
- `pandas` 
- `tensorflow` 
- `scikit-learn` 
- `jproperties` 
- `keras` 
- `logging` 

## Clustering-based CN0 EMOS models

The clustering-based CN0 EMOS models are implemented in R and follow these steps:

1. **Data loading**
   - Load observational data (`verobs`) and forecast data (`ensSumDay1`, `ensSumDay2`).
   - Extract station locations, forecast times, and dates for observations and predictions.

2. **Preprocessing**
   - Identify common dates, times, and locations across forecasts and observations.
   - Define the verification period and training period length.

3. **Model configuration**
   - Set up parameters for the EMOS model (location: `a`, `bM`, `b0`; scale: `c`, `d`).

4. **Model training**
   - Use clustering to group stations based on forecast and observation similarities. Ensure that each cluster has at least `c.min` stations.
   - For each day in the verification period, fit the CN0 EMOS model using two forecast horizons:
     - `0-24h forecast`: Use `ensSumDay1` and corresponding observations (`verobs`).
     - `24-48h forecast`: Use `ensSumDay2` and corresponding observations (`verobs`).
   - The model estimates parameters (`a`, `bM`, `b0`, `c`, `d`) for each cluster using a regression approach.

5. **Parallel Processing**
   - Utilize parallel computing to train models for each forecast horizon efficiently.
   - The `foreach` and `doParallel` libraries allow parallelization, speeding up computations.

6. **Model evaluation & results Storage**
   - After training, reshape the parameter arrays for both forecast horizons.
   - Save the estimated parameters (`radParsEmos24`, `radParsEmos48`) to an output file for later analysis and evaluation.

7. **Optional: performance Metrics**
   - You can compute performance metrics (e.g., CRPS) to evaluate the accuracy of the probabilistic forecasts generated by the model.

### ðŸ“‚ Project structure
This section provides an overview of the R files in this project.
The codes can be found in the `EMOS` folder.

- `EmosFitRadCN.R` - Main script, fits CN0 EMOS models to WRF forecasts and corresponding observations and returns the array of EMOS parameters
  -  **Input:**:  `radSumData.RData`
  -  **Output**: `radParsEmos_trainTp_ClustCl_CNCmin.RData` (Tp: length of the training period; Cl: number of clusters; Cmin: minimal number of locations in a cluster)
- `EmosFuncRad.R` - Auxiliary file containing the necessary functions for EMOS modelling. Reqired by `EmosFitRadCN.R`
- `EmosScoresRadCN.R` - Calculates verification measures for the CN0 EMOS models.
  -  **Input:** `radSumData.RData`, `radParsEmos_trainTp_ClustCl_CNCmin.RData` (Tp: length of the training period; Cl: number of clusters; Cmin: minimal number of locations in a cluster)
  -  **Output:** `radScoresEmos_trainTp_ClustCl_CNCmin.RData` (Tp: length of the training period; Cl: number of clusters; Cmin: minimal number of locations in a cluster)

# Note

These models are specifically adapted to the dataset we use, and different datasets may require the application of models with different architectures.
